================================================================================
FULL PERIOD BACKTEST: OPPORTUNITY GATING with 4x LEVERAGE
================================================================================

Testing with LEVERAGE and DYNAMIC SIZING

Loading Entry models (Enhanced with 5-fold CV - 20251024_012445)...
Loading Exit models (Enhanced - 20251023_212712)...
  ✅ Entry models loaded: LONG(85), SHORT(79)
  ✅ Exit models loaded: LONG(47), SHORT(47)

Loading FULL historical data...
  ✅ Full data loaded: 32,841 candles (~114 days)

Calculating ALL features (Enhanced v2 + EXIT)...
================================================================================
ENHANCED FEATURE CALCULATION V2
================================================================================

Step 1/4: Calculating baseline features (LONG + SHORT)...
Calculating ALL features (LONG + SHORT)...
  1/4 Calculating LONG basic features...
  2/4 Calculating LONG advanced features...
  3/4 Calculating SHORT features...
  4/4 Cleaning NaN values...
  ✅ All features calculated (32841 rows)
  ✅ Baseline: 107 features

Step 2/4: Calculating long-term features (200-period)...
  ✅ Long-term: 23 features

Step 3/4: Calculating advanced indicators (production)...

✅ Advanced indicators calculated:
   - Rows: 32,841 → 32,641 (lost 200 due to lookback)

Step 4/4: Calculating engineered ratio features...
Traceback (most recent call last):
  File "C:\Users\J\AppData\Roaming\Python\Python313\site-packages\pandas\core\indexes\base.py", line 3812, in get_loc
    return self._engine.get_loc(casted_key)
           ~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^
  File "pandas/_libs/index.pyx", line 167, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/index.pyx", line 196, in pandas._libs.index.IndexEngine.get_loc
  File "pandas/_libs/hashtable_class_helper.pxi", line 7088, in pandas._libs.hashtable.PyObjectHashTable.get_item
  File "pandas/_libs/hashtable_class_helper.pxi", line 7096, in pandas._libs.hashtable.PyObjectHashTable.get_item
KeyError: 'vp_value_area_high'

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "C:\Users\J\OneDrive\CLAUDE_CODE_FIN\bingx_rl_trading_bot\scripts\experiments\full_backtest_opportunity_gating_4x.py", line 135, in <module>
    df = calculate_all_features_enhanced_v2(df_full, phase='production')
  File "C:\Users\J\OneDrive\CLAUDE_CODE_FIN\bingx_rl_trading_bot\scripts\experiments\calculate_all_features_enhanced_v2.py", line 242, in calculate_all_features_enhanced_v2
    df = calculate_advanced_ratio_features(df)
  File "C:\Users\J\OneDrive\CLAUDE_CODE_FIN\bingx_rl_trading_bot\scripts\experiments\calculate_all_features_enhanced_v2.py", line 52, in calculate_advanced_ratio_features
    va_width = df['vp_value_area_high'] - df['vp_value_area_low']
               ~~^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\J\AppData\Roaming\Python\Python313\site-packages\pandas\core\frame.py", line 4113, in __getitem__
    indexer = self.columns.get_loc(key)
  File "C:\Users\J\AppData\Roaming\Python\Python313\site-packages\pandas\core\indexes\base.py", line 3819, in get_loc
    raise KeyError(key) from err
KeyError: 'vp_value_area_high'
